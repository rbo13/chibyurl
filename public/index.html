<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>chibyURL</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.3.5/dist/alpine.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script>
  </head>

  <body>
    <section class="section" x-data="chiby()">
      <div class="container">
        <h3 class="title">
          chibyURL, minifies your URL!
        </h3>

        <form @submit.prevent="minifyURL()">
          <div class="field">
            <label class="label" for="url">URL</label>
            <div class="control">
              <input
                x-model="url"
                id="url"
                name="url"
                class="input"
                type="url"
                placeholder="http://myawesomesite.com" />
            </div>
          </div>

          <div class="field">
            <label class="label" for="alias">URL Alias</label>
            <div class="control">
              <input
                x-model="alias"
                id="alias"
                name="alias"
                class="input"
                type="text"
                placeholder="MyAwesomeAlias" />
            </div>
          </div>

          <div class="control">
            <button type="submit" class="button is-success is-rounded is-outlined">chibify!</button>
          </div>
        </form>

        <div
          x-show="visible"
          class="box mt-4">
          <div class="field">
            <button
              x-on:click="clipboard"
              data-clipboard-action="copy"
              id="clipboard"
              class="button is-small is-pulled-right">Copy</button>
          </div>

          <p x-text="output">
          </p>
        </div>


      </div>
    </section>

    <script>
      function chiby() {
        return {
          url: '',
          alias: '',
          output: '',
          visible: false,
          async minifyURL() {
            const url = this.url.trim()
            const alias = this.alias.trim()
            this.visible = true

            const API_URL = 'http://localhost:8000'
            // const API_URL = 'https://chiby.herokuapp.com'

            const response = await window.fetch(API_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json; charset=utf-8'
              },
              body: JSON.stringify({
                "alias": alias,
                "url": url
              })
            })

            const data = await response.json()
            this.output = `${API_URL}/${data.payload.alias}`
          },
          clipboard() {
            const clipboard = new ClipboardJS('#clipboard', {
              text: () => {
                return this.output
              }
            })

            clipboard.on('success', (e) => {
              console.log(e)
            })

            clipboard.on('error', (err) => {
              console.error(err)
            })
          }
        }
      }
    </script>
  </body>
</html>